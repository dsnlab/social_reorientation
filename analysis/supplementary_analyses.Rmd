---
title: "Supplementary material analyses"
author: "Dani Cosme"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    highlight: tango
    theme: united
    toc: true
    toc_float: 
      collapsed: TRUE
      smooth_scroll: TRUE
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.path = "figs/SM/")

options(scipen = 999)
```

This document provides the code for the analyses reported in:

[Cosme et al. (Preprint) Testing the adolescent social reorientation model using hierarchical growth curve modeling with parcellated fMRI data](https://psyarxiv.com/8eyf5/)

This script reproduces the analyses reported in supplementary material.

# load packages
```{r}
library(tidyverse)
library(knitr)
library(lme4)
library(lmerTest)
```

# define color palettes and labels
```{r}
pal_self_other = c("#FFA90A", "#247BA0")
pal_social_academic = c("#63647E", "#F25F5C")
pal_wave = c("#693668", "#A74482", "#F84AA7")
pal_label = c("#47A8BD", "#DBC057", "#FF3366")
pal_gender = c("#70c1b3","#247BA0")

parcel_labeller = labeller(label = c('social' = 'social parcels', 'other' = 'control parcels', 'self' = 'self parcels'),
                           domain = c('social' = 'social domain', 'academic' = 'academic domain'),
                           wave = c("t1" = "wave 1", "t2" = "wave 2", "t3" = "wave 3"))

dcbw = theme_classic() +
  theme(text = element_text(size = 14, family = "Futura Medium", color = "black"),
        panel.background = element_blank(),
        plot.background = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(size = 14),
        legend.background = element_rect(fill = NA, color = NA),
        axis.line = element_line(color = "black"),
        axis.text = element_text(color = "black"),
        panel.grid.minor = element_blank())
```

# load MRI data

-   exclude participants with \>20% volumes with motion artifacts or low quality FX data
-   standardize betas within parcel (across participants and time)
-   recode standardized betas +/- 3 SDs from the mean as NA (0.8% of all observations)

```{r}
# define parcels
self_parcels = c(5, 17, 28, 47, 52, 66, 116, 147, 152, 156, 184, 198, 207, 225, 249, 292, 309, 354, 380)
social_parcels = c(18, 23, 29, 49, 54, 59, 62, 63, 67, 76, 111, 114, 139, 143, 146, 150, 178, 179, 189, 203, 212, 224, 229, 236, 238, 239, 245, 250, 259, 266, 271, 301, 305, 310, 322, 324, 328, 331, 333, 342, 343, 350, 374, 391)

# mri exclusions
mri_exclusions = c('s002_t1', 's004_t1', 's008_t1', 's011_t1', 's017_t1', 
                   's026_t1', 's033_t2', 's034_t1', 's041_t1', 's044_t1', 
                   's047_t1', 's051_t1', 's054_t1', 's057_t1', 's059_t1', 
                   's061_t1', 's063_t1', 's070_t2', 's074_t1', 's074_t2', 
                   's078_t1', 's084_t1', 's090_t2', 's090_t3', 's094_t1', 
                   's094_t2', 's096_t1') 

# mri exclusions
parcellations = read_csv('../data/fxParcellations.csv') %>%
  mutate(label = ifelse(parcellation %in% self_parcels, 'self',
                 ifelse(parcellation %in% social_parcels, 'social', 'other'))) %>%
  mutate(wave = paste0("t", as.numeric(c(`10` = 1, `13` = 2, `16` = 3)[as.character(age)]))) %>%
  select(-age) %>%
  unite(sub_wave, c(subjectID, wave), remove = FALSE) %>%
  group_by(parcellation) %>%
  mutate(inclusion = ifelse(sub_wave %in% mri_exclusions, "excluded from MRI", "completed MRI"),
         beta = ifelse(sub_wave %in% mri_exclusions, NA, beta),
         sd = ifelse(sub_wave %in% mri_exclusions, NA, sd),
         beta_std = scale(beta, center = FALSE, scale = TRUE),
         mean_beta_std = mean(beta_std, na.rm = TRUE)) %>%
    select(-sub_wave) %>%
  ungroup()

# exclude parameter estimates 3 SD from the mean
parcellations_ex = parcellations %>%
  mutate(beta_std = ifelse(beta_std > mean_beta_std + 3 | beta_std < mean_beta_std - 3, NA, beta_std))
```

# load cleaned SPPC and task data
```{r}
# demographics
race_ethnicity = readxl::read_xlsx("../data/Ethnicity_w1.xlsx") %>%
  extract(SID, "subjectID", "L([0-9]{3})-.*") %>%
  mutate(subjectID = sprintf("s%s", subjectID),
         hispanic_latinx = ifelse(Ethnicity == 1, "yes", "no"),
         race = recode(Race, `1` = "White", `2` = "Multiracial", `3` = "Pacific Islander",
                       `4` = "Native American", `5` = "Black or African American")) %>%
  select(subjectID, hispanic_latinx, race)

demo = read.csv("../data/SFIC_age.pds.gender.csv") %>%
  rename("subjectID" = SID,
         "wave" = wavenum,
         "gender" = Gender) %>%
  mutate(subjectID = sprintf("s%03d", subjectID),
         wave = paste0("t", wave),
         age_c = age - 13,
         age_c2 = age_c^2,
         pdss_c = pdss - 3,
         pdss_c2 = pdss_c^2) %>%
  full_join(., race_ethnicity)

# self-report
sppc = readRDS("../data/sppc.RDS")

# task
task = readRDS("../data/task.RDS") %>%
  ungroup() %>%
  mutate(percent_stdgm = (task_percent - mean(task_percent, na.rm = TRUE)) / 10, #center at grand mean, in units of 10%
         percent_std50 = (task_percent - 50) / 10,
         percent_std = (task_percent - 50) / 10) %>% #center at 50, in units of 10%
  group_by(target, domain) %>%
  mutate(percent_stdc = (task_percent - mean(task_percent, na.rm = TRUE)) / 10) #center at condition mean, in units of 10%

# merge data
merged = parcellations_ex %>%
  full_join(., task, by = c("subjectID", "wave", "domain", "target")) %>%
  full_join(., sppc, by = c("subjectID", "wave", "domain")) %>%
  full_join(., demo, by = c("subjectID", "wave")) %>%
  mutate(inclusion = ifelse(is.na(inclusion), "didn't complete MRI", inclusion)) %>%
  filter(!(subjectID == "s086" & wave == "t3")) #no MRI, task, or self-report data was collected

# subset data for modeling
neuro_model_data_pdss = merged %>%
  filter(!is.na(beta)) %>%
  select(subjectID, wave, pdss, pdss_c, pdss_c2, target, domain, parcellation, label, beta, beta_std)

neuro_model_data_ex_pdss = neuro_model_data_pdss  %>%
  na.omit()

comp_model_data = merged %>%
  select(subjectID, wave, pdss, pdss_c, pdss_c2, age, age_c, age_c2, domain, competence) %>%
  unique() %>%
  na.omit()

imp_model_data = merged %>%
  select(subjectID, wave, pdss, pdss_c, pdss_c2, age, age_c, age_c2, domain, importance) %>%
  unique() %>%
  na.omit()

status_model_data = merged %>%
  select(subjectID, wave, pdss, pdss_c, pdss_c2, age, age_c, age_c2, target, domain, task_percent, contains("percent")) %>%
  unique() %>%
  na.omit()

# dummy code target and domain
neuro_model_data_dummy_pdss = neuro_model_data_ex_pdss %>%
  mutate(target = ifelse(target == "self", .5, -.5),
         domain = ifelse(domain == "social", .5, -.5))
```

# sample descriptives {.tabset}
## full sample
```{r}
merged %>% 
  select(subjectID, wave, age, gender) %>%
  unique() %>%
  group_by(wave) %>%
  summarize(n = n(),
            meanAge = mean(age, na.rm = TRUE),
            sdAge = sd(age, na.rm = TRUE)) %>%
  kable(format = 'pandoc', digits = 2)

merged %>% 
  select(subjectID, wave, age, gender) %>%
  unique() %>%
  group_by(wave, gender) %>%
  summarize(n = n()) %>%
  spread(gender, n) %>%
  kable(format = 'pandoc', digits = 2)

merged %>% 
  select(subjectID, hispanic_latinx, race) %>%
  unique() %>%
  group_by(hispanic_latinx, race) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  mutate(total = sum(n),
         percent = (n/total) * 100) %>%
  select(-n, -total) %>%
  spread(hispanic_latinx, percent) %>%
  kable(format = 'pandoc', digits = 1)
```

## broken down by inclusion
```{r}
age_table = merged %>% 
  select(subjectID, inclusion, wave, age, pdss, gender) %>%
  unique() %>%
  group_by(inclusion, wave) %>%
  summarize(N = n(),
            Mage = mean(age, na.rm = TRUE),
            SDage = sd(age, na.rm = TRUE),
            Mpdss = mean(pdss, na.rm = TRUE),
            SDpdss = sd(pdss, na.rm = TRUE))

gender_table = merged %>% 
  select(subjectID, inclusion, wave, age, pds, gender) %>%
  unique() %>%
  group_by(inclusion, wave, gender) %>%
  summarize(N = n()) %>%
  spread(gender, N) %>%
  rename("Female" = F,
         "Male" = M)

merged %>% 
  select(subjectID, inclusion, hispanic_latinx, race) %>%
  unique() %>%
  group_by(inclusion, hispanic_latinx, race) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  mutate(total = sum(n),
         percent = (n/total) * 100) %>%
  select(-n, -total) %>%
  spread(hispanic_latinx, percent) %>%
  kable(format = 'pandoc', digits = 1)

age_table %>%
  left_join(gender_table) %>%
  extract(wave, "Wave", "t([1-3]{1})") %>%
  arrange(Wave) %>%
  select(Wave, inclusion, N, Mage, SDage, Mpdss, SDpdss, Female, Male) %>%
  rename("MRI status" = inclusion) %>%
  kable(format = 'pandoc', digits = 2)
```

## age and puberty correlations
```{r}
cor_fun = function(data) pmap(var.names, ~ cor.test(data[[.x]], data[[.y]])) %>% 
  map_df(broom::tidy) %>% 
  cbind(var.names, .)

age_pds = merged %>%
  select(subjectID, wave, gender, age, pdss) %>%
  gather(dev, value, age, pdss) %>%
  unite(wave_dev, dev, wave, sep = " ", remove = TRUE) %>%
  rownames_to_column() %>%
  spread(wave_dev, value) %>%
  group_by(subjectID) %>%
  fill(everything(), .direction = "up") %>%
  fill(everything(), .direction = "down") %>%
  select(-rowname) %>%
  unique() %>%
  ungroup()

var.names = tidystringdist::tidy_comb_all(names(select(age_pds, -c(subjectID, gender)))) %>%
  filter(!(grepl("age", V1) & grepl("age", V2)))

age_pds %>%
  nest(-c(gender)) %>%
  mutate(
    test = map(data, cor_fun)
  ) %>% 
  unnest(test, .drop = TRUE) %>%
  mutate(r = sprintf("%.02f", estimate), #sprintf("%.02f [%.02f, %.02f]", estimate, conf.low, conf.high)
         r = ifelse(p.value < .05 & p.value >= .01, paste0(r,"*"),
             ifelse(p.value < .01 & p.value >= .001, paste0(r,"**"),
             ifelse(p.value < .001, paste0(r,"***"), r))),
         r = gsub("0\\.", "\\.", r)) %>%
  select(gender, V1, V2, r) %>%
  rename("Sex" = gender) %>%
  unique() %>%
  mutate(V1 = gsub("age", "Age", V1),
         V2 = gsub("age", "Age", V2),
         V1 = gsub("pdss", "PDS-S", V1),
         V2 = gsub("pdss", "PDS-S", V2),
         V1 = gsub("t", "", V1),
         V2 = gsub("t", "", V2)) %>%
  spread(V2, r) %>%
  arrange(Sex) %>%
  filter(Sex == "F") %>%
  mutate_if(is.character, funs(ifelse(is.na(.), "–-", .))) %>%
  kable(format = "pandoc")

age_pds %>%
  nest(-c(gender)) %>%
  mutate(
    test = map(data, cor_fun)
  ) %>% 
  unnest(test, .drop = TRUE) %>%
  mutate(r = sprintf("%.02f", estimate), #sprintf("%.02f [%.02f, %.02f]", estimate, conf.low, conf.high)
         r = ifelse(p.value < .05 & p.value >= .01, paste0(r,"*"),
             ifelse(p.value < .01 & p.value >= .001, paste0(r,"**"),
             ifelse(p.value < .001, paste0(r,"***"), r))),
         r = gsub("0\\.", "\\.", r)) %>%
  select(gender, V1, V2, r) %>%
  rename("Sex" = gender) %>%
  unique() %>%
  mutate(V1 = gsub("age", "Age", V1),
         V2 = gsub("age", "Age", V2),
         V1 = gsub("pdss", "PDS-S", V1),
         V2 = gsub("pdss", "PDS-S", V2),
         V1 = gsub("t", "", V1),
         V2 = gsub("t", "", V2)) %>%
  spread(V1, r) %>%
  arrange(Sex) %>%
  filter(Sex == "M") %>%
  mutate_if(is.character, funs(ifelse(is.na(.), "–-", .))) %>%
  kable(format = "pandoc")
```

## plot {.tabset}
### full sample
```{r sample, fig.width = 5, fig.height = 9}
merged %>% 
  select(subjectID, wave, gender, age, inclusion) %>%
  group_by(subjectID) %>%
  unique() %>%
  mutate(n.waves = n()) %>%
  ungroup() %>%
  arrange(n.waves, gender, age, inclusion) %>%
  mutate(order = row_number()) %>%
  ggplot(aes(age, reorder(subjectID, -order), color = gender)) +
    geom_line(size = .3) + 
    geom_point(aes(shape = inclusion), size = 2, fill = "white") +
    scale_color_manual(values = pal_gender, name = "", labels = c("female", "male")) +
    scale_shape_manual(name = "", values = c(19, 17, 21)) +
    labs(x = "\npubertal stage (PSD score)", y = "participant\n") +
    dcbw +
    theme(axis.line = element_line(colour = "black"),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          legend.position = c(.75,.92),
          legend.spacing.y = unit(.01, 'cm'),
          legend.margin = unit(0, "cm"))
```

### MRI only
```{r sample MRI, fig.width = 5, fig.height = 9}
merged %>% 
  filter(!inclusion == "didn't complete MRI") %>%
  mutate(inclusion = ifelse(grepl("excluded", inclusion), "excluded", "included")) %>%
  select(subjectID, wave, gender, age, inclusion) %>%
  group_by(subjectID) %>%
  unique() %>%
  mutate(n.waves = n()) %>%
  ungroup() %>%
  arrange(n.waves, gender, age, inclusion) %>%
  mutate(order = row_number()) %>%
  ggplot(aes(age, reorder(subjectID, -order), color = gender)) +
    geom_line(size = .3) + 
    geom_point(aes(shape = inclusion), size = 2, fill = "white") +
    scale_color_manual(values = pal_gender, name = "", labels = c("female", "male")) +
    scale_shape_manual(name = "", values = c(21, 19)) +
    labs(x = "\npubertal stage (PSD score)", y = "participant\n") +
    dcbw +
    theme(axis.line = element_line(colour = "black"),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          legend.position = c(.75,.92),
          legend.spacing.y = unit(.01, 'cm'),
          legend.margin = unit(0, "cm"))
```

# neural puberty models {.tabset}
## visualize raw {.tabset}
Visualize the developmental trajectories using the raw data

### hypothesis 0
```{r h0_raw_pdss, fig.width=12, fig.height=5}
domain_parc_plot_raw = neuro_model_data_pdss %>%
  distinct(parcellation, target, domain, pdss, label, .keep_all = T) %>%
  group_by(subjectID, wave, label, domain, parcellation) %>%
  mutate(beta_std_avg = mean(beta_std, na.rm = TRUE)) %>%
  ggplot(aes(x = pdss, y = beta_std_avg, color = domain)) + 
  geom_smooth(aes(group = interaction(parcellation, domain), size = label),
              method = "lm", formula = y ~ poly(x, 2), se = FALSE, show.legend = FALSE) +
  geom_smooth(aes(fill = domain), method = "lm", formula = y ~ poly(x, 2), size = 1.5) +
  scale_color_manual(values = pal_social_academic) +
  scale_fill_manual(values = pal_social_academic) +
  scale_size_manual(values = c(.05, .1, .1)) +
  scale_y_continuous(breaks = seq(-2, 2, 1)) + 
  coord_cartesian(ylim = c(-2, 2)) +
  facet_grid(~ label, labeller = parcel_labeller) +
  labs(x = '\npubertal stage (PSD score)', y = 'mean standardized parameter estimate\n', color = '', fill = '') +
  theme_minimal(base_size = 12) +
  dcbw +
  theme(legend.position = c(.85, .15),
        legend.spacing.y = unit(.01, 'cm'),
        legend.margin = unit(0, "cm"))

target_parc_plot_raw = neuro_model_data_pdss %>%
  distinct(parcellation, target, domain, pdss, label, .keep_all = T) %>%
  group_by(subjectID, wave, label, target, parcellation) %>%
  mutate(beta_std_avg = mean(beta_std, na.rm = TRUE)) %>%
  ggplot(aes(x = pdss, y = beta_std_avg, color = target)) + 
  geom_smooth(aes(group = interaction(parcellation, target), size = label),
              method = "lm", formula = y ~ poly(x, 2), se = FALSE, show.legend = FALSE) +
  geom_smooth(aes(fill = target), method = "lm", formula = y ~ poly(x, 2), size = 1.5) +
  scale_color_manual(values = pal_self_other) +
  scale_fill_manual(values = pal_self_other) +
  scale_size_manual(values = c(.05, .1, .1)) +
  scale_y_continuous(breaks = seq(-2, 2, 1)) + 
  coord_cartesian(ylim = c(-2, 2)) +
  facet_grid(~ label, labeller = parcel_labeller) +
  labs(x = '\npubertal stage (PSD score)', y = 'mean standardized parameter estimate\n', color = '', fill = '') +
  theme_minimal(base_size = 12) +
  dcbw +
  theme(legend.position = c(.85, .15),
        legend.spacing.y = unit(.01, 'cm'),
        legend.margin = unit(0, "cm"))

(h0_raw = cowplot::plot_grid(domain_parc_plot_raw, target_parc_plot_raw,
                                labels = c('A', 'B'), ncol = 2,
                                rel_widths = c(1, 1)))
```

### hypothesis 1
```{r h1_raw_pdss, fig.width=12, fig.height=5}
domain_plot_raw = neuro_model_data_pdss %>%
  distinct(parcellation, target, domain, pdss, label, .keep_all = T) %>%
  group_by(subjectID, wave, label, domain, parcellation) %>%
  mutate(beta_std_avg = mean(beta_std, na.rm = TRUE)) %>%
  ggplot(aes(x = pdss, y = beta_std_avg, group = domain, color = domain)) +
  geom_smooth(aes(fill = domain), method = 'lm', formula = y ~ poly(x,2), alpha = .2) + 
  scale_color_manual(values = pal_social_academic) +
  scale_fill_manual(values = pal_social_academic) +
  scale_y_continuous(breaks = round(seq(-.6, .6, .2), 1)) +
  coord_cartesian(ylim = c(-.6, .65)) +
  facet_grid(~ label, labeller = parcel_labeller) +
  labs(x = '\npubertal stage (PSD score)', y = 'mean standardized parameter estimate\n', color = '', fill = '') +
  dcbw +
  theme(legend.position = c(.85, .15),
        legend.spacing.y = unit(.01, 'cm'),
        legend.margin = unit(0, "cm"))

soc_acad_plot_raw = neuro_model_data_pdss %>%
  group_by(subjectID, pdss, label, domain, parcellation) %>%
  mutate(beta_std_avg = mean(beta_std, na.rm = TRUE)) %>%
  select(subjectID, pdss, label, domain, beta_std_avg) %>%
  unique() %>%
  spread(domain, beta_std_avg) %>%
  mutate(avg_diff = social - academic) %>%
  distinct(parcellation, pdss, label, .keep_all = T) %>%
  ggplot(aes(x = pdss, y = avg_diff)) +
  geom_smooth(aes(group = parcellation, size = label), method = "lm", formula = y ~ poly(x, 2),
              se = FALSE, color = "grey50") +
  geom_smooth(method = 'lm', formula = y ~ poly(x,2), 
              se = TRUE, color = pal_social_academic[2], fill = pal_social_academic[2], size = 1.5) + 
  scale_size_manual(values = c(.03, .1, .1)) +
  scale_y_continuous(breaks = round(seq(-.6, .6, .2), 1)) +
  coord_cartesian(ylim = c(-.6, .65)) +
  facet_grid(~ label, labeller = parcel_labeller) +
  labs(x = "\npubertal stage (PSD score)", y = "mean standardized BOLD signal value\n",  color = '', fill = '') +
  dcbw +
  theme(legend.position = c(.85, .15),
        legend.spacing.y = unit(.01, 'cm'),
        legend.margin = unit(0, "cm"))

(h1_raw = cowplot::plot_grid(domain_plot_raw, soc_acad_plot_raw,
                                labels = c('A', 'B'), ncol = 2,
                                rel_widths = c(1, 1)))
```

### hypothesis 2
```{r h2_raw_pdss, fig.width=12, fig.height=5}
target_plot_raw = neuro_model_data_pdss %>%
  distinct(parcellation, target, domain, pdss, label, .keep_all = T) %>%
  group_by(subjectID, wave, label, target, parcellation) %>%
  mutate(beta_std_avg = mean(beta_std, na.rm = TRUE)) %>%
  ggplot(aes(x = pdss, y = beta_std_avg, group = target, color = target)) +
  geom_smooth(aes(fill = target), method = 'lm', formula = y ~ poly(x,2), alpha = .2) + 
  scale_color_manual(values = pal_self_other) +
  scale_fill_manual(values = pal_self_other) +
  scale_y_continuous(breaks = round(seq(-.4, .4, .2), 1)) +
  coord_cartesian(ylim = c(-.5, .5)) +
  facet_grid(~ label, labeller = parcel_labeller) +
  labs(x = '\npubertal stage (PSD score)', y = 'mean standardized parameter estimate\n', color = '', fill = '') +
  dcbw +
  theme(legend.position = c(.85, .15),
        legend.spacing.y = unit(.01, 'cm'),
        legend.margin = unit(0, "cm"))

self_other_plot_raw = neuro_model_data_pdss %>%
  group_by(subjectID, pdss, label, target, parcellation) %>%
  mutate(beta_std_avf = mean(beta_std, na.rm = TRUE)) %>%
  select(subjectID, pdss, label, target, beta_std_avf) %>%
  unique() %>%
  spread(target, beta_std_avf) %>%
  mutate(avg_diff = self - other) %>%
  distinct(parcellation, pdss, label, .keep_all = T) %>%
  ggplot(aes(x = pdss, y = avg_diff)) +
  geom_smooth(aes(group = parcellation, size = label), method = "lm", formula = y ~ poly(x, 2),
              se = FALSE, color = "grey50") +
  geom_smooth(method = 'lm', formula = y ~ poly(x,2), 
              se = TRUE, color = pal_self_other[2], fill = pal_self_other[2], size = 1.5) + 
  scale_size_manual(values = c(.03, .1, .1)) +
  scale_y_continuous(breaks = round(seq(-.4, .4, .2), 1)) +
  coord_cartesian(ylim = c(-.5, .5)) +
  facet_grid(~ label, labeller = parcel_labeller) +
  labs(x = "\npubertal stage (PSD score)", y = "mean standardized BOLD signal value\n",  color = '', fill = '') +
  dcbw +
  theme(legend.position = c(.85, .15),
        legend.spacing.y = unit(.01, 'cm'),
        legend.margin = unit(0, "cm"))

(h2_raw = cowplot::plot_grid(target_plot_raw, self_other_plot_raw,
                                labels = c('A', 'B'), ncol = 2,
                                rel_widths = c(1, 1)))
```

### hypothesis 3
```{r h3_raw_pdss, fig.width=15, fig.height=5}
int_plot_raw = neuro_model_data_pdss %>%
  distinct(parcellation, target, domain, pdss, beta_std, label, .keep_all = T) %>%
  ggplot(aes(x = pdss, y = beta_std, group = interaction(target, domain), color = domain, linetype = target)) +
  geom_smooth(aes(fill = domain), method = 'lm', formula = y ~ poly(x,2), alpha = .2) + 
  scale_y_continuous(breaks = c(-.4, .2, 0, .2, .4)) +
  coord_cartesian(ylim = c(-.4, .45)) +
  scale_color_manual(values = pal_social_academic) +
  scale_fill_manual(values = pal_social_academic) +
  scale_linetype_manual(name = "", values = c("dotted", "solid")) +
  facet_grid(~ label, labeller = parcel_labeller) +
  labs(x = '\npubertal stage (PSD score)', y = 'mean standardized parameter estimate\n', color = '', linetype = '', fill = '') +
  guides(linetype = guide_legend(override.aes = list(color = "black"))) +
  dcbw +
  theme(legend.position = c(.75, .15),
        legend.spacing.y = unit(.01, 'cm'),
        legend.margin = unit(.5, "cm"),
        legend.direction = "vertical",
        legend.box = "horizontal")

soc_acad_int_plot_raw = neuro_model_data_pdss %>%
  group_by(subjectID, pdss, label, target, domain, parcellation) %>%
  mutate(beta_std_avg = mean(beta_std, na.rm = TRUE)) %>%
  select(subjectID, pdss, label, target, domain, beta_std_avg) %>%
  unique() %>%
  spread(domain, beta_std_avg) %>%
  mutate(avg_diff = social - academic) %>%
  distinct(parcellation, pdss, label, .keep_all = T) %>%
  ggplot(aes(x = pdss, y = avg_diff, color = target)) +
  geom_smooth(aes(group = interaction(parcellation, target), size = label),
              method = "lm", formula = y ~ poly(x, 2), se = FALSE, show.legend = FALSE) +
  geom_smooth(aes(fill = target), method = 'lm', formula = y ~ poly(x,2), 
              se = TRUE, size = 1.5) + 
  scale_color_manual(values = pal_self_other) +
  scale_fill_manual(values = pal_self_other) +
  scale_size_manual(values = c(.03, .1, .1)) +
  scale_y_continuous(breaks = round(seq(-.6, .6, .2), 1)) +
  coord_cartesian(ylim = c(-.65, .65)) +
  facet_grid(~ label, labeller = parcel_labeller) +
  labs(x = "\npubertal stage (PSD score)", y = "mean standardized BOLD signal value\n",  color = '', fill = '') +
  dcbw +
  theme(legend.position = c(.85, .15),
        legend.spacing.y = unit(.01, 'cm'),
        legend.margin = unit(0, "cm"))

self_other_int_plot_raw = neuro_model_data_pdss %>%
  group_by(subjectID, pdss, label, domain, target, parcellation) %>%
  mutate(beta_std_avg = mean(beta_std, na.rm = TRUE)) %>%
  select(subjectID, pdss, label, domain, target, beta_std_avg) %>%
  unique() %>%
  spread(target, beta_std_avg) %>%
  mutate(avg_diff = self - other) %>%
  distinct(parcellation, pdss, label, .keep_all = T) %>%
  ggplot(aes(x = pdss, y = avg_diff, color = domain)) +
  geom_smooth(aes(group = interaction(parcellation, domain), size = label),
              method = "lm", formula = y ~ poly(x, 2), se = FALSE, show.legend = FALSE) +
  geom_smooth(aes(fill = domain), method = 'lm', formula = y ~ poly(x,2), 
              se = TRUE, size = 1.5) + 
  scale_color_manual(values = pal_social_academic) +
  scale_fill_manual(values = pal_social_academic) +
  scale_size_manual(values = c(.03, .1, .1)) +
  scale_y_continuous(breaks = round(seq(-.6, .6, .2), 1)) +
  coord_cartesian(ylim = c(-.65, .65)) +
  facet_grid(~ label, labeller = parcel_labeller) +
  labs(x = "\npubertal stage (PSD score)", y = "mean standardized BOLD signal value\n",  color = '', fill = '') +
  dcbw +
  theme(legend.position = c(.85, .15),
        legend.spacing.y = unit(.01, 'cm'),
        legend.margin = unit(0, "cm"))

(h3_raw = cowplot::plot_grid(int_plot_raw, soc_acad_int_plot_raw, self_other_int_plot_raw,
                       labels = c('A', 'B', 'C'), ncol = 3))
```

## run models {.tabset}
Estimate full models

### domain x puberty
```{r}
model_domain_equation = formula(beta_std ~ 1 + pdss_c*domain*label +
                                  pdss_c2*domain*label +
                                  (1 + pdss_c*domain || subjectID) +
                                  (1 + pdss_c*domain + pdss_c2*domain || parcellation))

model_domain_formula = lFormula(model_domain_equation, data = neuro_model_data_dummy_pdss)

model_domain_numFx = length(dimnames(model_domain_formula$X)[[2]])

model_domain_numRx = sum(as.numeric(lapply(model_domain_formula$reTrms$cnms, function(x) {
  l <- length(x)
  (l*(l - 1)) / 2 + l
})))

model_domain_maxfun = 10*(model_domain_numFx + model_domain_numRx + 1)^2

if (file.exists("../data/model_domain_pdss.RDS")) {
  model_domain = readRDS("../data/model_domain_pdss.RDS")
} else {
  model_domain = lmer(model_domain_equation, data = neuro_model_data_dummy_pdss, REML = F, #Use ML since we want to compare random effects
                      verbose = 2,
                      control = lmerControl(optCtrl = list(maxfun = model_domain_maxfun), optimizer = "bobyqa", calc.derivs = FALSE))
  saveRDS(model_domain, "../data/model_domain_pdss.RDS")
}

```

### domain x target x puberty
```{r}
model_target_equation = formula(beta_std ~ 1 + pdss_c*target*domain*label +
                                  pdss_c2*target*domain*label +
                                  (1 + pdss_c*target*domain || subjectID) +
                                  (1 + pdss_c*target*domain + pdss_c2*target*domain || parcellation))

model_target_formula = lFormula(model_target_equation, data = neuro_model_data_dummy_pdss)

model_target_numFx = length(dimnames(model_target_formula$X)[[2]])

model_target_numRx = sum(as.numeric(lapply(model_target_formula$reTrms$cnms, function(x) {
  l <- length(x)
  (l*(l - 1)) / 2 + l
})))

model_target_maxfun = 10*(model_target_numFx + model_target_numRx + 1)^2

if (file.exists("../data/model_target_pdss.RDS")) {
  model_target = readRDS("../data/model_target_pdss.RDS")
} else {
  model_target = lmer(model_target_equation, data = neuro_model_data_dummy_pdss, REML = F, #Use ML since we want to compare random effects
                      verbose = 2,
                      control = lmerControl(optCtrl = list(maxfun = model_target_maxfun), optimizer = "bobyqa", calc.derivs = FALSE))
  saveRDS(model_target, "../data/model_target_pdss.RDS")
}

```

## compare
```{r}
anova(model_domain, model_target) %>%
  as.data.frame() %>%
  select(npar, AIC, Chisq, Df, `Pr(>Chisq)`) %>%
  rownames_to_column() %>%
  rename("model" = rowname,
         "model df" = Df,
         "X2" = Chisq,
         "X2 df" = Df,
         "p" = `Pr(>Chisq)`) %>%
  mutate(AIC = round(AIC, 2),
         X2 = round(X2, 2),
         p = round(p, 3),
         p = ifelse(p == 0, "< .001", gsub("0.(.*)", ".\\1", p))) %>%
  mutate_if(is.numeric, funs(ifelse(is.na(.), "--", .))) %>%
  mutate_if(is.character, funs(ifelse(is.na(.), "--", .))) %>%
  kable(format = "pandoc")
```

## summarize best fitting model
```{r}
model_target %>%
  broom.mixed::tidy(effects = c("ran_pars", "fixed"), conf.int = TRUE) %>%
  filter(effect == "fixed") %>%
  select(-group) %>%
  rename("b" = estimate,
         "SE" = std.error,
         "t" = statistic,
         "p" = p.value) %>%
  mutate(p = round(p, 3),
         p = ifelse(p == 0, "< .001", gsub("0.(.*)", ".\\1", sprintf("%.3f", p))),
         term = gsub("\\(Intercept\\)", "Intercept (puberty 3, label (control))", term),
         term = gsub("target", "Target", term),
         term = gsub("domain", "Domain", term),
         term = gsub("labelself", "Label (self)", term),
         term = gsub("labelsocial", "Label (social)", term),
         term = gsub("pdss_c", "Puberty", term),
         term = gsub(":", " x ", term),
         term = gsub("sd__", "", term),
         term = gsub("Observation", "observation", term),
         effect = gsub("ran_pars", "random", effect),
         `b [95% CI]` = ifelse(effect == "fixed", sprintf("%.3f [%.3f, %.3f]", b, conf.low, conf.high), "--")) %>%
  mutate_if(is.numeric, round, 3) %>%
  mutate_if(is.numeric, funs(ifelse(is.na(.), "--", .))) %>%
  mutate_if(is.character, funs(ifelse(is.na(.), "--", .))) %>%
  select(term, `b [95% CI]`, SE, t, df, p) %>%
  kable(format = "pandoc")
  
# summarize random effects
print(VarCorr(model_target), comp = c("Variance","Std.Dev."), digits = 3)
```

## visualize fitted models {.tabset}
Visualize the developmental trajectory using the fitted values from the domain x target x age model

```{r}
reForm = as.formula("~(1 + pdss_c*target*domain + pdss_c2*target*domain || parcellation)")

neuro_plot_data_puberty = with(neuro_model_data_dummy_pdss, 
                    expand.grid(target = unique(target), 
                                domain = unique(domain),
                                parcellation = unique(parcellation),
                                pdss = unique(pdss),
                                stringsAsFactors = F)) %>%
  mutate(label = ifelse(parcellation %in% self_parcels, 'self',
                 ifelse(parcellation %in% social_parcels, 'social', 'other')),
         pdss_c = pdss - 3, 
         pdss_c2 = pdss_c^2, 
         subjectID = NA)

neuro_plot_data_puberty$expected = predict(model_target, newdata = neuro_plot_data_puberty, re.form = reForm)
neuro_plot_data_puberty$expected_mean = predict(model_target, newdata = neuro_plot_data_puberty, re.form = NA)

neuro_plot_data_puberty = neuro_plot_data_puberty %>%
  mutate(target = factor(target, levels = c(-.5, .5), labels = c("other", "self")),
         domain = factor(domain, levels = c(-.5, .5), labels = c("academic", "social")))
```

### hypothesis 0
```{r h0_fitted_pdss, fig.width=12, fig.height=5}
domain_parc_plot = neuro_plot_data_puberty %>%
  distinct(parcellation, target, domain, pdss, label, .keep_all = T) %>%
  group_by(subjectID, pdss, label, domain, parcellation) %>%
  mutate(expected_avg = mean(expected, na.rm = TRUE)) %>%
  ggplot(aes(x = pdss, y = expected_avg, color = domain)) + 
  geom_smooth(aes(group = interaction(parcellation, domain), size = label), method = "lm", formula = y ~ poly(x, 2), se = FALSE, show.legend = FALSE) +
  geom_smooth(method = "lm", formula = y ~ poly(x, 2), size = 1.25, se = FALSE) +
  scale_color_manual(name = "", values = pal_social_academic) +
  scale_size_manual(values = c(.05, .1, .1)) +
  scale_y_continuous(breaks = c(-1, 0, 1)) + 
  coord_cartesian(ylim = c(-1.2, 1.2)) +
  facet_grid(~label, labeller = parcel_labeller) +
  labs(x = "\npubertal stage (PSD score)", y = "mean predicted BOLD signal value\n") + 
  dcbw +
  theme(legend.position = c(.85, .15),
        legend.spacing.y = unit(.01, 'cm'),
        legend.margin = unit(0, "cm"))

target_parc_plot = neuro_plot_data_puberty %>%
  distinct(parcellation, target, domain, pdss, label, .keep_all = T) %>%
  group_by(subjectID, pdss, label, target, parcellation) %>%
  mutate(expected_avg = mean(expected, na.rm = TRUE)) %>%
  ggplot(aes(x = pdss, y = expected_avg, color = target)) + 
  geom_smooth(aes(group = interaction(parcellation, target), size = label), method = "lm", formula = y ~ poly(x, 2), se = FALSE, show.legend = FALSE) +
  geom_smooth(method = "lm", formula = y ~ poly(x, 2), size = 1.25, se = FALSE) +
  scale_color_manual(values = pal_self_other) +
  scale_size_manual(values = c(.05, .1, .1)) +
  scale_y_continuous(breaks = c(-1, 0, 1)) + 
  coord_cartesian(ylim = c(-1.2, 1.2)) +
  facet_grid(~label, labeller = parcel_labeller) +
  labs(x = "\npubertal stage (PSD score)", y = "mean predicted BOLD signal value\n", color = "") + 
  dcbw +
  theme(legend.position = c(.85, .15),
        legend.spacing.y = unit(.01, 'cm'),
        legend.margin = unit(0, "cm"))

(h0_fitted = cowplot::plot_grid(domain_parc_plot, target_parc_plot,
                                labels = c('A', 'B'), ncol = 2,
                                rel_widths = c(1, 1)))
```

### hypothesis 1
```{r h1_fitted_pdss, fig.width=12, fig.height=5}
domain_plot = neuro_plot_data_puberty %>%
  group_by(subjectID, pdss, label, domain, parcellation) %>%
  mutate(expected_avg = mean(expected_mean, na.rm = TRUE)) %>%
  distinct(parcellation, target, domain, pdss, label, .keep_all = T) %>%
  ggplot(aes(x = pdss, y = expected_avg, color = domain)) +
  #geom_point(aes(group = target)) + 
  geom_smooth(method = 'lm', formula = y ~ poly(x,2), alpha = .2, se = FALSE, size = 1.25) + 
  scale_y_continuous(breaks = seq(-.2, .45, .2)) +
  coord_cartesian(ylim = c(-.25, .4)) +
  scale_color_manual(values = pal_social_academic) +
  facet_grid(~ label, labeller = parcel_labeller) +
  labs(x = "\npubertal stage (PSD score)", y = "mean predicted BOLD signal value\n",  color = '') +
  dcbw +
  theme(legend.position = c(.85, .15),
        legend.spacing.y = unit(.01, 'cm'),
        legend.margin = unit(0, "cm"))

soc_acad_plot = neuro_plot_data_puberty %>%
  group_by(subjectID, pdss, label, domain, parcellation) %>%
  mutate(expected_avg = mean(expected, na.rm = TRUE)) %>%
  select(subjectID, pdss, label, domain, expected_avg) %>%
  unique() %>%
  spread(domain, expected_avg) %>%
  mutate(expected_diff = social - academic) %>%
  distinct(parcellation, pdss, label, .keep_all = T) %>%
  ggplot(aes(x = pdss, y = expected_diff)) +
  geom_smooth(aes(group = parcellation, size = label), method = "lm", formula = y ~ poly(x, 2),
              se = FALSE, color = "grey50") +
  geom_smooth(method = 'lm', formula = y ~ poly(x,2), 
              se = FALSE, color = pal_social_academic[2], size = 1.5) + 
  scale_size_manual(values = c(.03, .1, .1)) +
  scale_y_continuous(breaks = seq(-.2, .45, .2)) +
  coord_cartesian(ylim = c(-.25, .4)) +
  facet_grid(~ label, labeller = parcel_labeller) +
  labs(x = "\npubertal stage (PSD score)", y = "mean predicted BOLD signal value\n",  color = '') +
  dcbw +
  theme(legend.position = "none")

(h1_fitted = cowplot::plot_grid(domain_plot, soc_acad_plot,
                                labels = c('A', 'B'), ncol = 2,
                                rel_widths = c(1, 1)))
```

### hypothesis 2
```{r h2_fitted_pdss, fig.width=12, fig.height=5}
target_plot = neuro_plot_data_puberty %>%
  group_by(subjectID, pdss, label, target, parcellation) %>%
  mutate(expected_avg = mean(expected_mean, na.rm = TRUE)) %>%
  distinct(parcellation, target, target, pdss, label, .keep_all = T) %>%
  ggplot(aes(x = pdss, y = expected_avg, color = target)) +
  #geom_point(aes(group = target)) + 
  geom_smooth(method = 'lm', formula = y ~ poly(x,2), alpha = .2, se = FALSE, size = 1.25) + 
  scale_y_continuous(breaks = seq(-.1, .3, .1)) +
  coord_cartesian(ylim = c(-.15, .3)) +
  scale_color_manual(values = pal_self_other) +
  facet_grid(~ label, labeller = parcel_labeller) +
  labs(x = "\npubertal stage (PSD score)", y = "mean predicted BOLD signal value\n",  color = '') +
  dcbw +
  theme(legend.position = c(.85, .15),
        legend.spacing.y = unit(.01, 'cm'),
        legend.margin = unit(0, "cm"))

self_other_plot = neuro_plot_data_puberty %>%
  group_by(subjectID, pdss, label, target, parcellation) %>%
  mutate(expected_avg = mean(expected, na.rm = TRUE)) %>%
  select(subjectID, pdss, label, target, expected_avg) %>%
  unique() %>%
  spread(target, expected_avg) %>%
  mutate(expected_diff = self - other) %>%
  distinct(parcellation, pdss, label, .keep_all = T) %>%
  ggplot(aes(x = pdss, y = expected_diff)) +
  geom_smooth(aes(group = parcellation, size = label), method = "lm", formula = y ~ poly(x, 2),
              se = FALSE, color = "grey50") +
  geom_smooth(method = 'lm', formula = y ~ poly(x,2), 
              se = FALSE, color = pal_self_other[2], size = 1.5) + 
  scale_size_manual(values = c(.03, .1, .1)) +
  scale_y_continuous(breaks = seq(-.1, .3, .1)) +
  coord_cartesian(ylim = c(-.15, .3)) +
  facet_grid(~ label, labeller = parcel_labeller) +
  labs(x = "\npubertal stage (PSD score)", y = "mean predicted BOLD signal value\n",  color = '') +
  dcbw +
  theme(legend.position = "none")

(h2_fitted = cowplot::plot_grid(target_plot, self_other_plot,
                                labels = c('A', 'B'), ncol = 2,
                                rel_widths = c(1, 1)))
```

### hypothesis 3
```{r h3_fitted_pdss, fig.width=15, fig.height=5}
int_plot = neuro_plot_data_puberty %>%
  distinct(parcellation, target, domain, pdss, label, .keep_all = T) %>%
  ggplot(aes(x = pdss, y = expected_mean, group = interaction(target, domain), color = domain, linetype = target)) +
  geom_smooth(method = 'lm', formula = y ~ poly(x,2), alpha = 1, se = FALSE, size = 1.25) + 
  #geom_point() + 
  scale_y_continuous(breaks = c(-.4, -.2, 0, .2, .4)) +
  coord_cartesian(ylim = c(-.4, .45)) +
  scale_color_manual(values = pal_social_academic) +
  scale_linetype_manual(name = "", values = c("dotted", "solid")) +
  facet_grid(~ label, labeller = parcel_labeller) +
  labs(x = "\npubertal stage (PSD score)", y = "mean predicted BOLD signal value\n",  color = '', linetype = '') +
  guides(linetype = guide_legend(override.aes = list(color = "black"))) +
  dcbw +
  theme(legend.position = c(.75, .15),
        legend.spacing.y = unit(.01, 'cm'),
        legend.margin = unit(.5, "cm"),
        legend.direction = "vertical",
        legend.box = "horizontal")

soc_acad_int_plot = neuro_plot_data_puberty %>%
  group_by(subjectID, pdss, label, target, domain, parcellation) %>%
  mutate(expected_avg = mean(expected, na.rm = TRUE)) %>%
  select(subjectID, pdss, label, target, domain, expected_avg) %>%
  unique() %>%
  spread(domain, expected_avg) %>%
  mutate(expected_diff = social - academic) %>%
  distinct(parcellation, pdss, label, .keep_all = T) %>%
  ggplot(aes(x = pdss, y = expected_diff, color = target)) +
  geom_smooth(aes(group = interaction(parcellation, target), size = label),
              method = "lm", formula = y ~ poly(x, 2), se = FALSE, show.legend = FALSE) +
  geom_smooth(method = 'lm', formula = y ~ poly(x,2), 
              se = FALSE, size = 1.5) + 
  scale_color_manual(values = pal_self_other) +
  scale_size_manual(values = c(.03, .1, .1)) +
  scale_y_continuous(breaks = c(-.4, -.2, 0, .2, .4)) +
  coord_cartesian(ylim = c(-.4, .45)) +
  facet_grid(~ label, labeller = parcel_labeller) +
  labs(x = "\npubertal stage (PSD score)", y = "mean predicted BOLD signal value\n",  color = '') +
  dcbw +
  theme(legend.position = c(.85, .15),
        legend.spacing.y = unit(.01, 'cm'),
        legend.margin = unit(0, "cm"))


self_other_int_plot = neuro_plot_data_puberty %>%
  group_by(subjectID, pdss, label, domain, target, parcellation) %>%
  mutate(expected_avg = mean(expected, na.rm = TRUE)) %>%
  select(subjectID, pdss, label, domain, target, expected_avg) %>%
  unique() %>%
  spread(target, expected_avg) %>%
  mutate(expected_diff = self - other) %>%
  distinct(parcellation, pdss, label, .keep_all = T) %>%
  ggplot(aes(x = pdss, y = expected_diff, color = domain)) +
  geom_smooth(aes(group = interaction(parcellation, domain), size = label),
              method = "lm", formula = y ~ poly(x, 2), se = FALSE, show.legend = FALSE) +
  geom_smooth(method = 'lm', formula = y ~ poly(x,2), 
              se = FALSE, size = 1.5) + 
  scale_color_manual(values = pal_social_academic) +
  scale_size_manual(values = c(.03, .1, .1)) +
  scale_y_continuous(breaks = c(-.4, -.2, 0, .2, .4)) +
  coord_cartesian(ylim = c(-.4, .45)) +
  facet_grid(~ label, labeller = parcel_labeller) +
  labs(x = "\npubertal stage (PSD score)", y = "mean predicted BOLD signal value\n",  color = '') +
  dcbw +
  theme(legend.position = c(.85, .15),
        legend.spacing.y = unit(.01, 'cm'),
        legend.margin = unit(0, "cm"))

(h3_fitted = cowplot::plot_grid(int_plot, soc_acad_int_plot, self_other_int_plot,
                       labels = c('A', 'B', 'C'), ncol = 3))
```

# self/other evaluation task analyses {.tabset}
## visualize raw {.tabset}
### age
```{r status_age}
(status_plot_raw_age = status_model_data %>%
  filter(!is.na(task_percent)) %>%
  ggplot(aes(age, task_percent, color = domain, fill = domain, linetype = target)) +
    geom_point(alpha = .1) +
    geom_line(aes(group = interaction(subjectID, target, domain)), alpha = .1) +
    geom_smooth(method = "lm", formula = y ~ poly(x, 2), alpha = .2) +
    scale_x_continuous(limits = c(min(status_model_data$age), 18), breaks = c(10, 12, 14, 16, 18)) +
    scale_color_manual(name = "", values = pal_social_academic) +
    scale_fill_manual(name = "", values = pal_social_academic) +
    scale_linetype_manual(name = "", values = c("dotted", "solid")) +
    guides(linetype = guide_legend(override.aes = list(color = "black"))) +
    labs(x = "\npubertal stage (PSD score)", y = "social status or academic proficiency\n(% endorsed)\n") +
    dcbw +
    theme(legend.position = c(.88, .2),
          legend.spacing.y = unit(.01, 'cm'),
          legend.margin = unit(0, "cm")))
```

### puberty
```{r status_puberty}
(status_plot_raw = status_model_data %>%
  filter(!is.na(task_percent)) %>%
  ggplot(aes(pdss, task_percent, color = domain, fill = domain, linetype = target)) +
    geom_point(alpha = .1) +
    geom_line(aes(group = interaction(subjectID, target, domain)), alpha = .1) +
    geom_smooth(method = "lm", formula = y ~ poly(x, 2), alpha = .2) +
    scale_color_manual(name = "", values = pal_social_academic) +
    scale_fill_manual(name = "", values = pal_social_academic) +
    scale_linetype_manual(name = "", values = c("dotted", "solid")) +
    guides(linetype = guide_legend(override.aes = list(color = "black"))) +
    labs(x = "\npubertal stage (PDS score)", y = "social status or academic proficiency\n(% endorsed)\n") +
    dcbw +
    theme(legend.position = c(.88, .2),
          legend.spacing.y = unit(.01, 'cm'),
          legend.margin = unit(0, "cm")))
```

## run models {.tabset}
### ICC
```{r}
model.icc = anova(lm(task_percent ~ subjectID, data = status_model_data))
round(model.icc$`Sum Sq`[1] / sum(model.icc$`Sum Sq`), 2)
```

### age
```{r}
`status model 1` = lmer(task_percent ~ 1 + target*domain + 
                        (1 + target * domain | subjectID), 
                        data = status_model_data, control = lmerControl(optimizer = "bobyqa"))
`status model 2 age` = lmer(task_percent ~ 1 + target*domain + age_c + 
                        (1 + target * domain | subjectID), 
                        data = status_model_data, control = lmerControl(optimizer = "bobyqa"))
`status model 3 age` = lmer(task_percent ~ 1 + target*domain + age_c + age_c2 + 
                         (1 + target * domain | subjectID), 
                         data = status_model_data, control = lmerControl(optimizer = "bobyqa"))
`status model 4 age` = lmer(task_percent ~ 1 + target*domain*age_c + 
                            (1 + target * domain | subjectID), 
                           data = status_model_data, control = lmerControl(optimizer = "bobyqa"))
`status model 5 age` = lmer(task_percent ~ 1 + target*domain*age_c + 
                            target*domain*age_c2 + 
                            (1 + target * domain | subjectID), 
                            data = status_model_data, control = lmerControl(optimizer = "bobyqa"))
```

### puberty
```{r}
`status model 2 puberty` = lmer(task_percent ~ 1 + target*domain + pdss_c + 
                        (1 + target * domain | subjectID), 
                        data = status_model_data, control = lmerControl(optimizer = "bobyqa"))
`status model 3 puberty` = lmer(task_percent ~ 1 + target*domain + pdss_c + pdss_c2 + 
                         (1 + target * domain | subjectID), 
                         data = status_model_data, control = lmerControl(optimizer = "bobyqa"))
`status model 4 puberty` = lmer(task_percent ~ 1 + target*domain*pdss_c + 
                            (1 + target * domain | subjectID), 
                           data = status_model_data, control = lmerControl(optimizer = "bobyqa"))
`status model 5 puberty` = lmer(task_percent ~ 1 + target*domain*pdss_c + target*domain*pdss_c2 + 
                            (1 + target * domain | subjectID), 
                            data = status_model_data, control = lmerControl(optimizer = "bobyqa"))
```

### compare models {.tabset}
#### age
```{r}
anova(`status model 1`, `status model 2 age`, `status model 3 age`, `status model 4 age`, `status model 5 age`) %>%
  as.data.frame() %>%
  select(npar, AIC, Chisq, Df, `Pr(>Chisq)`) %>%
  rownames_to_column() %>%
  rename("model" = rowname,
         "model df" = Df,
         "X2" = Chisq,
         "X2 df" = Df,
         "p" = `Pr(>Chisq)`) %>%
  mutate(AIC = round(AIC, 2),
         X2 = round(X2, 2),
         p = round(p, 3),
         p = ifelse(p == 0, "< .001", gsub("0.(.*)", ".\\1", p))) %>%
  mutate_if(is.numeric, funs(ifelse(is.na(.), "--", .))) %>%
  mutate_if(is.character, funs(ifelse(is.na(.), "--", .))) %>%
  kable(format = "pandoc")
```

#### puberty
```{r}
anova(`status model 1`, `status model 2 puberty`, `status model 3 puberty`, `status model 4 puberty`, `status model 5 puberty`) %>%
  as.data.frame() %>%
  select(npar, AIC, Chisq, Df, `Pr(>Chisq)`) %>%
  rownames_to_column() %>%
  rename("model" = rowname,
         "model df" = Df,
         "X2" = Chisq,
         "X2 df" = Df,
         "p" = `Pr(>Chisq)`) %>%
  mutate(AIC = round(AIC, 2),
         X2 = round(X2, 2),
         p = round(p, 3),
         p = ifelse(p == 0, "< .001", gsub("0.(.*)", ".\\1", p))) %>%
  mutate_if(is.numeric, funs(ifelse(is.na(.), "--", .))) %>%
  mutate_if(is.character, funs(ifelse(is.na(.), "--", .))) %>%
  kable(format = "pandoc")
```

### summarize best fitting models {.tabset}
#### age
```{r}
`status model 5 age` %>%
  broom.mixed::tidy(effects = c("ran_pars", "fixed"), conf.int = TRUE) %>%
  filter(effect == "fixed") %>%
  select(-group) %>%
  rename("b" = estimate,
         "SE" = std.error,
         "t" = statistic,
         "p" = p.value) %>%
  mutate(p = round(p, 3),
         p = ifelse(p == 0, "< .001", gsub("0.(.*)", ".\\1", p)),
         term = gsub("\\(Intercept\\)", "Intercept (academic, other, age 13)", term),
         term = gsub("domainsocial", "Domain (social)", term),
         term = gsub("targetself", "Target (self)", term),
         term = gsub("age_c", "Age", term),
         term = gsub(":", " x ", term),
         term = gsub("sd__", "", term),
         term = gsub("Observation", "observation", term),
         effect = gsub("ran_pars", "random", effect),
         `b [95% CI]` = ifelse(effect == "fixed", sprintf("%.2f [%.2f, %.2f]", b, conf.low, conf.high), "--")) %>%
  mutate_if(is.numeric, round, 2) %>%
  mutate_if(is.numeric, funs(ifelse(is.na(.), "--", .))) %>%
  mutate_if(is.character, funs(ifelse(is.na(.), "--", .))) %>%
  select(term, `b [95% CI]`, SE, t, df, p) %>%
  kable(format = "pandoc")
  
print(VarCorr(`status model 5 age`), comp = c("Variance","Std.Dev."), digits = 5)
```

#### puberty
```{r}
`status model 4 puberty` %>%
  broom.mixed::tidy(effects = c("ran_pars", "fixed"), conf.int = TRUE) %>%
  filter(effect == "fixed") %>%
  select(-group) %>%
  rename("b" = estimate,
         "SE" = std.error,
         "t" = statistic,
         "p" = p.value) %>%
  mutate(p = round(p, 3),
         p = ifelse(p == 0, "< .001", gsub("0.(.*)", ".\\1", p)),
         term = gsub("\\(Intercept\\)", "Intercept (academic, other, stage 3)", term),
         term = gsub("domainsocial", "Domain (social)", term),
         term = gsub("targetself", "Target (self)", term),
         term = gsub("pdss_c", "Puberty", term),
         term = gsub(":", " x ", term),
         term = gsub("sd__", "", term),
         term = gsub("Observation", "observation", term),
         effect = gsub("ran_pars", "random", effect),
         `b [95% CI]` = ifelse(effect == "fixed", sprintf("%.2f [%.2f, %.2f]", b, conf.low, conf.high), "--")) %>%
  mutate_if(is.numeric, round, 2) %>%
  mutate_if(is.numeric, funs(ifelse(is.na(.), "--", .))) %>%
  mutate_if(is.character, funs(ifelse(is.na(.), "--", .))) %>%
  select(term, `b [95% CI]`, SE, t, df, p) %>%
  kable(format = "pandoc")
  
print(VarCorr(`status model 4 puberty`), comp = c("Variance","Std.Dev."), digits = 5)
```

## visualize fitted {.tabset}
### age
```{r}
model_to_plot = `status model 5 age`
REFormString = as.character(findbars(model_to_plot@call$formula)[[1]])
reForm = as.formula(paste0('~(', REFormString[[2]], REFormString[[1]], REFormString[[3]], ')'))
status_model_data$expected_mean = predict(model_to_plot, newdata = status_model_data, re.form = NA)

(status_plot_age = status_model_data %>%
  filter(!is.na(target)) %>%
  ggplot(aes(age, expected_mean, color = domain, linetype = target)) +
    geom_line(aes(age, task_percent, group = interaction(subjectID, target, domain)), alpha = .1) +
    geom_point(aes(age, task_percent, group = interaction(subjectID, target, domain)), alpha = .1) +
    geom_smooth(method = "lm", formula = y ~ poly(x, 2), alpha = .2, se = FALSE, size = 1.25) +
    scale_x_continuous(limits = c(min(status_model_data$age), 18), breaks = c(10, 12, 14, 16, 18)) +
    scale_color_manual(name = "", values = pal_social_academic) +
    scale_linetype_manual(name = "", values = c("dotted", "solid")) +
    coord_cartesian(ylim = c(0, 100)) +
    guides(linetype = guide_legend(override.aes = list(color = "black"))) +
    labs(x = "\npubertal stage (PSD score)", y = "social status or academic proficiency\n") +
    dcbw +
    theme(legend.position = "none"))
```

### puberty
````{r}
model_to_plot = `status model 4 puberty`
REFormString = as.character(findbars(model_to_plot@call$formula)[[1]])
reForm = as.formula(paste0('~(', REFormString[[2]], REFormString[[1]], REFormString[[3]], ')'))
status_model_data$expected_mean = predict(model_to_plot, newdata = status_model_data, re.form = NA)

(status_plot_pdss = status_model_data %>%
  filter(!is.na(target)) %>%
  ggplot(aes(pdss, expected_mean, color = domain, linetype = target)) +
    geom_line(aes(pdss, task_percent, group = interaction(subjectID, target, domain)), alpha = .1) +
    geom_point(aes(pdss, task_percent, group = interaction(subjectID, target, domain)), alpha = .1) +
    geom_smooth(method = "lm", formula = y ~ poly(x, 2), alpha = .2, se = FALSE, size = 1.25) +
    scale_color_manual(name = "", values = pal_social_academic) +
    scale_linetype_manual(name = "", values = c("dotted", "solid")) +
    coord_cartesian(ylim = c(0, 100)) +
    guides(linetype = guide_legend(override.aes = list(color = "black"))) +
    labs(x = "\npubertal stage (PDS score)", y = "social status or academic proficiency\n") +
    dcbw +
    theme(legend.position = c(.8, .14),
          legend.spacing.x = unit(.1, 'cm'),
          legend.box = "horizontal"))
```

### combined
```{r, fig.width = 12, fig.height = 4.5}
cowplot::plot_grid(status_plot_age, status_plot_pdss, labels = c('A', 'B'), ncol = 2)
```

# SPPC competence analysis {.tabset}
## visualize raw {.tabset}
### age
```{r competence_age}
(comp_plot_raw_age = comp_model_data %>%
  ggplot(aes(age, competence, color = domain, fill = domain)) +
    geom_point(alpha = .1) +
    geom_line(aes(group = interaction(subjectID, domain)), alpha = .1) +
    geom_smooth(method = "lm", formula = y ~ poly(x, 2), alpha = .2) +
    scale_color_manual(name = "", values = pal_social_academic) +
    scale_fill_manual(name = "", values = pal_social_academic) +
    coord_cartesian(ylim = c(1, 4)) +
    labs(x = "\npubertal stage (PSD score)", y = "mean competence rating\n") +
    dcbw +
    theme(legend.position = c(.88, .2),
          legend.spacing.y = unit(.01, 'cm'),
          legend.margin = unit(0, "cm")))
```

### puberty
```{r competence_puberty}
(comp_plot_raw = comp_model_data %>%
  ggplot(aes(pdss, competence, color = domain)) +
    geom_point(alpha = .1) +
    geom_line(aes(group = interaction(subjectID, domain)), alpha = .1) +
    geom_smooth(method = "lm", formula = y ~ poly(x, 2), alpha = .2) +
    scale_color_manual(name = "", values = pal_social_academic) +
    coord_cartesian(ylim = c(1, 4)) +
    labs(x = "\npubertal stage (PDS score)", y = "mean competence rating\n") +
    dcbw +
    theme(legend.position = c(.88, .2),
          legend.spacing.y = unit(.01, 'cm'),
          legend.margin = unit(0, "cm")))
```

## run models {.tabset}
### ICC
```{r}
model.icc = anova(lm(competence ~ subjectID, data = comp_model_data))
round(model.icc$`Sum Sq`[1] / sum(model.icc$`Sum Sq`), 2)
```

### age

```{r}
`comp model 1` = lmer(competence ~ 1 + domain + 
                              (1 | subjectID), 
                              data = comp_model_data, control = lmerControl(optimizer = "bobyqa"))
`comp model 2 age` = lmer(competence ~ 1 + domain + age_c + 
                             (1 + age_c | subjectID), 
                             data = comp_model_data, control = lmerControl(optimizer = "bobyqa"))
`comp model 3 age` = lmer(competence ~ 1 + domain + age_c + age_c2 + 
                             (1 + age_c | subjectID), 
                             data = comp_model_data, control = lmerControl(optimizer = "bobyqa"))
`comp model 4 age` = lmer(competence ~ 1 + domain*age_c + 
                              (1 + age_c | subjectID), 
                              data = comp_model_data, control = lmerControl(optimizer = "bobyqa"))
`comp model 5 age` = lmer(competence ~ 1 + domain*age_c + domain*age_c2 + 
                              (1 + age_c | subjectID), 
                              data = comp_model_data, control = lmerControl(optimizer = "bobyqa"))
```

### puberty
```{r}
`comp model 2 puberty` = lmer(competence ~ 1 + domain + pdss_c + 
                             (1 + pdss_c | subjectID), 
                             data = comp_model_data, control = lmerControl(optimizer = "bobyqa"))
`comp model 3 puberty` = lmer(competence ~ 1 + domain + pdss_c + pdss_c2 + 
                             (1 + pdss_c | subjectID), 
                             data = comp_model_data, control = lmerControl(optimizer = "bobyqa"))
`comp model 4 puberty` = lmer(competence ~ 1 + domain*pdss_c + 
                              (1 + pdss_c | subjectID), 
                              data = comp_model_data, control = lmerControl(optimizer = "bobyqa"))
`comp model 5 puberty` = lmer(competence ~ 1 + domain*pdss_c + domain*pdss_c2 + 
                              (1 + pdss_c | subjectID), 
                              data = comp_model_data, control = lmerControl(optimizer = "bobyqa"))
```

### compare models {.tabset}
#### age
```{r}
anova(`comp model 1`, `comp model 2 age`, `comp model 3 age`, `comp model 4 age`, `comp model 5 age`) %>%
  as.data.frame() %>%
  select(npar, AIC, Chisq, Df, `Pr(>Chisq)`) %>%
  rownames_to_column() %>%
  rename("model" = rowname,
         "model df" = npar,
         "X2" = Chisq,
         "X2 df" = Df,
         "p" = `Pr(>Chisq)`) %>%
  mutate(AIC = round(AIC, 2),
         X2 = round(X2, 2),
         p = round(p, 3),
         p = ifelse(p == 0, "< .001", gsub("0.(.*)", ".\\1", p))) %>%
  mutate_if(is.numeric, funs(ifelse(is.na(.), "--", .))) %>%
  mutate_if(is.character, funs(ifelse(is.na(.), "--", .))) %>%
  kable(format = "pandoc")
```

#### puberty
```{r}
anova(`comp model 1`, `comp model 2 puberty`, `comp model 3 puberty`, `comp model 4 puberty`, `comp model 5 puberty`) %>%
  as.data.frame() %>%
  select(npar, AIC, Chisq, Df, `Pr(>Chisq)`) %>%
  rownames_to_column() %>%
  rename("model" = rowname,
         "model df" = npar,
         "X2" = Chisq,
         "X2 df" = Df,
         "p" = `Pr(>Chisq)`) %>%
  mutate(AIC = round(AIC, 2),
         X2 = round(X2, 2),
         p = round(p, 3),
         p = ifelse(p == 0, "< .001", gsub("0.(.*)", ".\\1", p))) %>%
  mutate_if(is.numeric, funs(ifelse(is.na(.), "--", .))) %>%
  mutate_if(is.character, funs(ifelse(is.na(.), "--", .))) %>%
  kable(format = "pandoc")
```

### summarize best fitting model {.tabset}
#### age
```{r}
# summarize best fitting model
`comp model 3 age` %>%
  broom.mixed::tidy(effects = c("ran_pars", "fixed"), conf.int = TRUE) %>%
  filter(effect == "fixed") %>%
  select(-group) %>%
  rename("b" = estimate,
         "SE" = std.error,
         "t" = statistic,
         "p" = p.value) %>%
  mutate(p = round(p, 3),
         p = ifelse(p == 0, "< .001", gsub("0.(.*)", ".\\1", p)),
         term = gsub("\\(Intercept\\)", "intercept (academic, age 13)", term),
         term = gsub("domainsocial", "domain (social)", term),
         term = gsub("age_c", "age", term),
         term = gsub(":", " x ", term),
         term = gsub("sd__", "", term),
         term = gsub("Observation", "observation", term),
         effect = gsub("ran_pars", "random", effect),
         `b [95% CI]` = ifelse(effect == "fixed", sprintf("%.2f [%.2f, %.2f]", b, conf.low, conf.high), "--"),
         SE = sprintf("%.3f", SE)) %>%
  mutate_if(is.numeric, round, 2) %>%
  mutate_if(is.numeric, funs(ifelse(is.na(.), "--", .))) %>%
  mutate_if(is.character, funs(ifelse(is.na(.), "--", .))) %>%
  select(term, `b [95% CI]`, SE, t, df, p) %>%
  kable(format = "pandoc")
  
# summarize random effects
print(VarCorr(`comp model 3 age`), comp = c("Variance","Std.Dev."), digits = 4)
```

### visualize fitted {.tabset}
#### age
```{r}
model_to_plot = `comp model 3 age`
REFormString = as.character(findbars(model_to_plot@call$formula)[[1]])
reForm = as.formula(paste0('~(', REFormString[[2]], REFormString[[1]], REFormString[[3]], ')'))
comp_model_data$expected = predict(model_to_plot, newdata = comp_model_data, re.form = reForm)
comp_model_data$expected_mean = predict(model_to_plot, newdata = comp_model_data, re.form = NA)

(comp_plot_age = comp_model_data %>%
  ggplot(aes(age, expected_mean, color = domain)) +
    geom_line(aes(age, competence, group = interaction(subjectID, domain)), alpha = .1) +
    geom_point(aes(age, competence, group = interaction(subjectID, domain)), alpha = .1) +
    geom_smooth(method = "lm", formula = y ~ poly(x, 2), alpha = .2) +
    scale_color_manual(name = "", values = pal_social_academic) +
    coord_cartesian(ylim = c(1, 4)) +
    labs(x = "\npubertal stage (PSD score)", y = "SPPC competence rating\n") +
    dcbw +
    theme(legend.position = "none"))
```

# SPPC importance analysis {.tabset}
## visualize raw {.tabset}
### age
```{r importance_age}
(imp_plot_raw_age = imp_model_data %>%
  filter(!is.na(importance)) %>%
  ggplot(aes(age, importance, color = domain, fill = domain)) +
    geom_point(alpha = .1) +
    geom_line(aes(group = interaction(subjectID, domain)), alpha = .1) +
    geom_smooth(method = "lm", alpha = .2) +
    scale_color_manual(name = "", values = pal_social_academic) +
    scale_fill_manual(name = "", values = pal_social_academic) +
    coord_cartesian(ylim = c(1, 4)) +
    scale_x_continuous(limits = c(12, 18), breaks = c(12, 14, 16, 18)) +
    labs(x = "\npubertal stage (PSD score)", y = "mean importance rating\n") +
    dcbw +
    theme(legend.position = c(.88, .2),
          legend.spacing.y = unit(.01, 'cm'),
          legend.margin = unit(0, "cm")))
```

### puberty
```{r importance_puberty}
(imp_plot_raw = imp_model_data %>%
  filter(!is.na(importance)) %>%
  ggplot(aes(pdss, importance, color = domain)) +
    geom_jitter(alpha = .1, width = .05, height = .05) +
    geom_line(aes(group = interaction(subjectID, domain)), alpha = .1) +
    geom_smooth(method = "lm", alpha = .2) +
    scale_color_manual(name = "", values = pal_social_academic) +
    coord_cartesian(ylim = c(1, 4)) +
    labs(x = "\npubertal stage (PDS score)", y = "mean importance rating\n") +
    dcbw +
    theme(legend.position = c(.88, .2),
          legend.spacing.y = unit(.01, 'cm'),
          legend.margin = unit(0, "cm")))
```

## run models {.tabset}
### ICC
```{r}
model.icc = anova(lm(importance ~ subjectID, data = imp_model_data))
round(model.icc$`Sum Sq`[1] / sum(model.icc$`Sum Sq`), 2)
```

### age
```{r}
`imp model 1` = lmer(importance ~ 1 + domain +
                           (1 + domain | subjectID), 
                           data = imp_model_data, control = lmerControl(optimizer = "bobyqa"))
`imp model 2 age` = lmer(importance ~ 1 + domain + age_c + 
                           (1 + domain | subjectID), 
                           data = imp_model_data, control = lmerControl(optimizer = "bobyqa"))
`imp model 3 age` = lmer(importance ~ 1 + domain*age_c + 
                           (1 + domain | subjectID), 
                           data = imp_model_data, control = lmerControl(optimizer = "bobyqa"))
```

### puberty
```{r}
`imp model 2 puberty` = lmer(importance ~ 1 + domain + pdss_c + 
                              (1 + domain | subjectID), 
                              data = imp_model_data, control = lmerControl(optimizer = "bobyqa"))
`imp model 3 puberty` = lmer(importance ~ 1 + domain*pdss_c + 
                              (1 + domain | subjectID), 
                              data = imp_model_data, control = lmerControl(optimizer = "bobyqa"))
```

## compare models {.tabset}
### age
```{r}
anova(`imp model 1`, `imp model 2 age`, `imp model 3 age`) %>%
  as.data.frame() %>%
  select(npar, AIC, Chisq, Df, `Pr(>Chisq)`) %>%
  rownames_to_column() %>%
  rename("model" = rowname,
         "model df" = Df,
         "X2" = Chisq,
         "X2 df" = Df,
         "p" = `Pr(>Chisq)`) %>%
  mutate(AIC = round(AIC, 2),
         X2 = round(X2, 2),
         p = round(p, 3),
         p = ifelse(p == 0, "< .001", gsub("0.(.*)", ".\\1", p))) %>%
  mutate_if(is.numeric, funs(ifelse(is.na(.), "--", .))) %>%
  mutate_if(is.character, funs(ifelse(is.na(.), "--", .))) %>%
  kable(format = "pandoc")
```

### puberty
```{r}
anova(`imp model 1`, `imp model 2 puberty`, `imp model 3 puberty`) %>%
  as.data.frame() %>%
  select(npar, AIC, Chisq, Df, `Pr(>Chisq)`) %>%
  rownames_to_column() %>%
  rename("model" = rowname,
         "model df" = Df,
         "X2" = Chisq,
         "X2 df" = Df,
         "p" = `Pr(>Chisq)`) %>%
  mutate(AIC = round(AIC, 2),
         X2 = round(X2, 2),
         p = round(p, 3),
         p = ifelse(p == 0, "< .001", gsub("0.(.*)", ".\\1", p))) %>%
  mutate_if(is.numeric, funs(ifelse(is.na(.), "--", .))) %>%
  mutate_if(is.character, funs(ifelse(is.na(.), "--", .))) %>%
  kable(format = "pandoc")
```

## summarize best fiting model
```{r}
`imp model 1` %>%
  broom.mixed::tidy(effects = c("ran_pars", "fixed"), conf.int = TRUE) %>%
  filter(effect == "fixed") %>%
  select(-group) %>%
  rename("b" = estimate,
         "SE" = std.error,
         "t" = statistic,
         "p" = p.value) %>%
  mutate(p = round(p, 3),
         p = ifelse(p == 0, "< .001", gsub("0.(.*)", ".\\1", p)),
         term = gsub("\\(Intercept\\)", "intercept (academic, age 13)", term),
         term = gsub("domainsocial", "domain (social)", term),
         term = gsub("age_c", "age", term),
         term = gsub(":", " x ", term),
         term = gsub("sd__", "", term),
         term = gsub("Observation", "observation", term),
         effect = gsub("ran_pars", "random", effect),
         `b [95% CI]` = ifelse(effect == "fixed", sprintf("%.2f [%.2f, %.2f]", b, conf.low, conf.high), "--")) %>%
  mutate_if(is.numeric, round, 2) %>%
  mutate_if(is.numeric, funs(ifelse(is.na(.), "--", .))) %>%
  mutate_if(is.character, funs(ifelse(is.na(.), "--", .))) %>%
  select(term, `b [95% CI]`, SE, t, df, p) %>%
  kable(format = "pandoc")
  
# summarize random effects
print(VarCorr(`imp model 1`), comp = c("Variance","Std.Dev."), digits = 4)
```

## visualize fitted
```{r}
imp_model_data_na = imp_model_data %>%
  filter(!is.na(importance))

model_to_plot = `imp model 1`
REFormString = as.character(findbars(model_to_plot@call$formula)[[1]])
reForm = as.formula(paste0('~(', REFormString[[2]], REFormString[[1]], REFormString[[3]], ')'))
imp_model_data_na$expected_mean = predict(model_to_plot, newdata = filter(imp_model_data_na, !is.na(importance)), re.form = NA)

(imp_plot_age = imp_model_data_na %>%
  ggplot(aes(age, expected_mean, color = domain)) +
    geom_line(aes(age, importance, group = interaction(subjectID, domain)), alpha = .1) +
    geom_point(aes(age, importance, group = interaction(subjectID, domain)), alpha = .1) +
    geom_smooth(method = "lm", formula = y ~ poly(x, 2), alpha = .2, se = FALSE) +
    scale_color_manual(name = "", values = pal_social_academic) +
    scale_x_continuous(limits = c(12, 18), breaks = c(12, 14, 16, 18)) +
    coord_cartesian(ylim = c(1, 4)) +
    labs(x = "\npubertal stage (PSD score)", y = "SPPC importance rating\n") +
    dcbw +
    theme(legend.position = c(.88, .14),
          legend.spacing.y = unit(.01, 'cm'),
          legend.margin = unit(0, "cm")))
```

# SPPC competence importance plot
```{r combined_behavior, fig.width=12, fig.height=4.5}
cowplot::plot_grid(comp_plot_age, imp_plot_age, ncol = 2, labels = c("A", "B"))
```


